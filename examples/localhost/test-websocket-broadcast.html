<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Broadcast Test</title>
</head>
<body>
    <h1>WebSocket Broadcast Test</h1>
    <ul id="test-list">
        <li>Existing Item</li>
    </ul>
    
    <script>
        // Connect to WebSocket
        const ws = new WebSocket('ws://localhost:3000/');
        
        ws.onopen = function() {
            console.log('WebSocket connected');
            
            // After WebSocket connects, make a POST request to add content
            setTimeout(() => {
                fetch('/', {
                    method: 'POST',
                    headers: {
                        'Range': 'selector=ul',
                        'Content-Type': 'text/html'
                    },
                    body: '<li>New Posted Item</li>'
                }).then(response => {
                    console.log('POST completed, status:', response.status);
                });
            }, 1000);
        };
        
        ws.onmessage = function(event) {
            console.log('WebSocket message received:', event.data);
            
            // Parse the StreamItem
            const parser = new DOMParser();
            const doc = parser.parseFromString(event.data, 'text/html');
            const method = doc.querySelector('[itemprop="method"]')?.textContent;
            const content = doc.querySelector('[itemprop="content"]')?.innerHTML;
            
            console.log('Method:', method);
            console.log('Content:', content);
            
            // Check if we received the posted content (not the entire ul)
            if (content && content.includes('New Posted Item') && !content.includes('Existing Item')) {
                console.log('✅ SUCCESS: WebSocket broadcast contains the posted content only');
            } else {
                console.log('❌ FAIL: WebSocket broadcast contains the target element instead of posted content');
                console.log('Expected: <li>New Posted Item</li>');
                console.log('Received:', content);
            }
        };
        
        ws.onerror = function(error) {
            console.log('WebSocket error:', error);
        };
    </script>
</body>
</html>