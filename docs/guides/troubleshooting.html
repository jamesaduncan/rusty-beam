<!DOCTYPE html>
<html>
<head>
    <title>Troubleshooting Guide - Rusty Beam</title>
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1, h2, h3 { color: #333; }
        code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f8f8; font-weight: bold; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .info { background: #e3f2fd; border: 1px solid #bbdefb; padding: 15px; border-radius: 5px; margin: 20px 0; }
        nav { margin-bottom: 20px; }
        nav a { margin-right: 10px; }
        .solution { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <nav>
        <a href="/">Home</a> → 
        <a href="/guides/">Guides</a> → 
        Troubleshooting
    </nav>
    
    <h1>Troubleshooting Guide</h1>
    
    <p>This guide helps you diagnose and resolve common issues with Rusty Beam.</p>
    
    <h2>Table of Contents</h2>
    <ul>
        <li><a href="#startup-issues">Startup Issues</a></li>
        <li><a href="#configuration-errors">Configuration Errors</a></li>
        <li><a href="#plugin-problems">Plugin Problems</a></li>
        <li><a href="#authentication-issues">Authentication Issues</a></li>
        <li><a href="#performance-problems">Performance Problems</a></li>
        <li><a href="#file-serving-errors">File Serving Errors</a></li>
        <li><a href="#selector-issues">CSS Selector Issues</a></li>
        <li><a href="#network-connectivity">Network Connectivity</a></li>
        <li><a href="#logging-debugging">Logging & Debugging</a></li>
        <li><a href="#common-errors">Common Error Messages</a></li>
        <li><a href="#getting-help">Getting Help</a></li>
    </ul>
    
    <h2 id="startup-issues">Startup Issues</h2>
    
    <h3>Server Won't Start</h3>
    
    <h4>Port Already in Use</h4>
    
    <div class="error">
Error: Failed to bind to 127.0.0.1:3000
OS Error: Address already in use (os error 98)
    </div>
    
    <div class="solution">
        <strong>Solution:</strong>
        <pre><code># Find process using the port
sudo lsof -i :3000
# or
sudo netstat -tlnp | grep :3000

# Kill the process
kill -9 &lt;PID&gt;

# Or change the port in config
&lt;td itemprop="port"&gt;3001&lt;/td&gt;</code></pre>
    </div>
    
    <h4>Permission Denied on Port</h4>
    
    <div class="error">
Error: Permission denied (os error 13)
    </div>
    
    <div class="solution">
        <strong>Solution for ports &lt; 1024:</strong>
        <pre><code># Option 1: Use a port &gt;= 1024
&lt;td itemprop="port"&gt;8080&lt;/td&gt;

# Option 2: Grant capability (Linux)
sudo setcap 'cap_net_bind_service=+ep' /usr/local/bin/rusty-beam

# Option 3: Use authbind
sudo apt-get install authbind
sudo touch /etc/authbind/byport/80
sudo chmod 500 /etc/authbind/byport/80
sudo chown rustybeam /etc/authbind/byport/80
authbind --deep rusty-beam config.html</code></pre>
    </div>
    
    <h4>Configuration File Not Found</h4>
    
    <div class="error">
Error: Failed to read configuration file: No such file or directory
    </div>
    
    <div class="solution">
        <strong>Solution:</strong>
        <pre><code># Check file exists
ls -la /path/to/config.html

# Use absolute path
rusty-beam /etc/rusty-beam/config.html

# Or relative path from current directory
cd /etc/rusty-beam
rusty-beam ./config.html</code></pre>
    </div>
    
    <h2 id="configuration-errors">Configuration Errors</h2>
    
    <h3>Invalid HTML Configuration</h3>
    
    <div class="error">
Error: Failed to parse configuration: Invalid HTML
    </div>
    
    <div class="solution">
        <strong>Solution:</strong>
        <ol>
            <li>Validate HTML syntax:
                <pre><code># Online validator
curl -s -F "out=json" -F "content=&lt;$(cat config.html)" \
  https://validator.w3.org/nu/ | jq .

# Or use local tool
tidy -errors -quiet config.html</code></pre>
            </li>
            <li>Check for unclosed tags</li>
            <li>Ensure proper microdata attributes</li>
            <li>Verify quotes around attribute values</li>
        </ol>
    </div>
    
    <h3>Missing Required Configuration</h3>
    
    <div class="error">
Error: Missing required property 'root' in ServerConfig
    </div>
    
    <div class="solution">
        <strong>Solution:</strong>
        <pre><code>&lt;table itemscope itemtype="http://rustybeam.net/ServerConfig"&gt;
    &lt;tr&gt;
        &lt;td&gt;Document Root&lt;/td&gt;
        &lt;td itemprop="root"&gt;/var/www/html&lt;/td&gt; &lt;!-- Required --&gt;
    &lt;/tr&gt;
&lt;/table&gt;</code></pre>
    </div>
    
    <h3>Invalid Path Configuration</h3>
    
    <div class="error">
Error: Document root does not exist: /var/www/html
    </div>
    
    <div class="solution">
        <strong>Solution:</strong>
        <pre><code># Create the directory
sudo mkdir -p /var/www/html
sudo chown rustybeam:rustybeam /var/www/html

# Or update config to existing directory
&lt;td itemprop="root"&gt;./public&lt;/td&gt;</code></pre>
    </div>
    
    <h2 id="plugin-problems">Plugin Problems</h2>
    
    <h3>Plugin Failed to Load</h3>
    
    <div class="error">
Error loading plugin: cannot open shared object file: No such file or directory
    </div>
    
    <div class="solution">
        <strong>Solution:</strong>
        <pre><code># Check plugin file exists
ls -la /path/to/plugin.so

# Check plugin dependencies
ldd /path/to/plugin.so

# Install missing dependencies
sudo apt-get install libssl-dev  # Example

# Rebuild plugins
./build-plugins.sh

# Use correct file:// URL
&lt;span itemprop="library"&gt;file:///usr/local/lib/rusty-beam/plugins/plugin.so&lt;/span&gt;</code></pre>
    </div>
    
    <h3>Plugin Incompatibility</h3>
    
    <div class="error">
Error: Plugin API version mismatch
    </div>
    
    <div class="solution">
        <strong>Solution:</strong>
        <ol>
            <li>Ensure plugins are built with same Rusty Beam version</li>
            <li>Rebuild all plugins:
                <pre><code>cd /path/to/rusty-beam
cargo clean
cargo build --release
./build-plugins.sh</code></pre>
            </li>
            <li>Check plugin compatibility in documentation</li>
        </ol>
    </div>
    
    <h3>Plugin Order Issues</h3>
    
    <table>
        <thead>
            <tr>
                <th>Problem</th>
                <th>Symptom</th>
                <th>Solution</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Auth after file handler</td>
                <td>No authentication prompt</td>
                <td>Move auth plugin before file handler</td>
            </tr>
            <tr>
                <td>Logging too early</td>
                <td>Missing user info in logs</td>
                <td>Move logging plugin to end</td>
            </tr>
            <tr>
                <td>CORS after auth</td>
                <td>Preflight requests fail</td>
                <td>Move CORS before authentication</td>
            </tr>
        </tbody>
    </table>
    
    <h2 id="authentication-issues">Authentication Issues</h2>
    
    <h3>Always Getting 401 Unauthorized</h3>
    
    <div class="solution">
        <strong>Check these items:</strong>
        <ol>
            <li>Verify credentials:
                <pre><code># Test with curl
curl -u username:password http://localhost:3000/

# Check auth file is readable
ls -la /path/to/users.html

# Verify user exists in auth file
grep "username" /path/to/users.html</code></pre>
            </li>
            <li>Check password encryption:
                <pre><code># For plaintext
&lt;td itemprop="encryption"&gt;plaintext&lt;/td&gt;

# For bcrypt
&lt;td itemprop="encryption"&gt;bcrypt&lt;/td&gt;</code></pre>
            </li>
            <li>Verify auth file format</li>
        </ol>
    </div>
    
    <h3>Bcrypt Password Validation Fails</h3>
    
    <div class="solution">
        <strong>Solution:</strong>
        <pre><code># Generate new bcrypt hash
python3 -c "import bcrypt; print(bcrypt.hashpw(b'password', bcrypt.gensalt()).decode())"

# Ensure hash is properly formatted
# Should start with $2a$, $2b$, or $2y$
# Example: $2b$10$N9qo8uLOickgx2ZMRZoMye...

# Test specific hash
python3 -c "
import bcrypt
hash = b'$2b$10$...'  # Your hash
password = b'testpass'  # Your password
print(bcrypt.checkpw(password, hash))
"</code></pre>
    </div>
    
    <h2 id="performance-problems">Performance Problems</h2>
    
    <h3>High CPU Usage</h3>
    
    <div class="solution">
        <strong>Diagnostic steps:</strong>
        <pre><code># Monitor CPU usage by thread
htop -H

# Profile the server
sudo perf top -p $(pgrep rusty-beam)

# Check for busy loops in logs
journalctl -u rusty-beam | grep -i "error\|warn"

# Common solutions:
# 1. Reduce compression level
&lt;meta itemprop="compression-level" content="3"&gt;

# 2. Limit worker threads
&lt;td itemprop="workers"&gt;4&lt;/td&gt;

# 3. Enable caching
&lt;meta itemprop="cache-control" content="max-age=3600"&gt;</code></pre>
    </div>
    
    <h3>Memory Leaks</h3>
    
    <div class="solution">
        <strong>Diagnostic steps:</strong>
        <pre><code># Monitor memory usage
ps aux | grep rusty-beam
# or
top -p $(pgrep rusty-beam)

# Check for unbounded caches
# Add cache limits:
&lt;meta itemprop="cache-size" content="104857600"&gt; &lt;!-- 100MB --&gt;
&lt;meta itemprop="cache-entries" content="1000"&gt;

# Enable memory profiling
RUST_LOG=rusty_beam=debug rusty-beam config.html</code></pre>
    </div>
    
    <h2 id="file-serving-errors">File Serving Errors</h2>
    
    <h3>404 Not Found for Existing Files</h3>
    
    <div class="solution">
        <strong>Check these items:</strong>
        <ol>
            <li>File permissions:
                <pre><code>ls -la /var/www/html/file.html
# Should be readable by server user
chmod 644 /var/www/html/file.html</code></pre>
            </li>
            <li>Case sensitivity:
                <pre><code># Linux is case-sensitive
# File.HTML != file.html</code></pre>
            </li>
            <li>Symlink resolution:
                <pre><code># Check if symlinks are followed
ls -la /var/www/html/
# Ensure target exists</code></pre>
            </li>
            <li>Virtual host configuration</li>
        </ol>
    </div>
    
    <h3>403 Forbidden Errors</h3>
    
    <div class="solution">
        <strong>Common causes:</strong>
        <ul>
            <li>Directory permissions (needs execute bit)</li>
            <li>SELinux/AppArmor restrictions</li>
            <li>Authorization plugin denying access</li>
        </ul>
        
        <pre><code># Fix directory permissions
find /var/www -type d -exec chmod 755 {} \;

# Check SELinux context (RHEL/CentOS)
ls -Z /var/www/html/
sudo chcon -R -t httpd_sys_content_t /var/www/html/

# Check AppArmor (Ubuntu/Debian)
sudo aa-status | grep rusty</code></pre>
    </div>
    
    <h2 id="selector-issues">CSS Selector Issues</h2>
    
    <h3>Invalid Selector Errors</h3>
    
    <div class="error">
Error: Invalid CSS selector
    </div>
    
    <div class="solution">
        <strong>Common issues:</strong>
        <ol>
            <li>Special characters need escaping:
                <pre><code># IDs with special chars
Range: selector=#user\.name  # For id="user.name"
Range: selector=#foo\:bar    # For id="foo:bar"

# Quotes in attribute selectors
Range: selector=[data-value=\"quoted\"]</code></pre>
            </li>
            <li>URL encoding for HTTP headers:
                <pre><code># Encode # as %23
curl -H "Range: selector=%23myid" http://localhost:3000/page.html

# Or use backslash escaping
curl -H "Range: selector=\#myid" http://localhost:3000/page.html</code></pre>
            </li>
        </ol>
    </div>
    
    <h3>No Elements Matched</h3>
    
    <div class="solution">
        <strong>Debugging steps:</strong>
        <pre><code># 1. Get the full document first
curl http://localhost:3000/page.html > page.html

# 2. Test selector with a tool
# Using pup (HTML parser)
cat page.html | pup '#myid'

# 3. Check element exists
grep "id=\"myid\"" page.html

# 4. Try simpler selectors
curl -H "Range: selector=h1" http://localhost:3000/page.html
curl -H "Range: selector=.class" http://localhost:3000/page.html</code></pre>
    </div>
    
    <h2 id="network-connectivity">Network Connectivity</h2>
    
    <h3>Connection Refused</h3>
    
    <div class="solution">
        <strong>Diagnostic steps:</strong>
        <pre><code># 1. Check if server is running
ps aux | grep rusty-beam
systemctl status rusty-beam

# 2. Check listening ports
sudo netstat -tlnp | grep rusty
# or
sudo ss -tlnp | grep rusty

# 3. Test local connection
curl -v http://127.0.0.1:3000/

# 4. Check firewall
sudo iptables -L -n
sudo ufw status

# 5. Check bind address
# If bound to 127.0.0.1, only local connections work
# Change to 0.0.0.0 for external access</code></pre>
    </div>
    
    <h3>Slow Response Times</h3>
    
    <div class="solution">
        <strong>Diagnostic steps:</strong>
        <pre><code># 1. Measure response time
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:3000/

# curl-format.txt:
    time_namelookup:  %{time_namelookup}s\n
       time_connect:  %{time_connect}s\n
    time_appconnect:  %{time_appconnect}s\n
   time_pretransfer:  %{time_pretransfer}s\n
      time_redirect:  %{time_redirect}s\n
 time_starttransfer:  %{time_starttransfer}s\n
                    ----------\n
         time_total:  %{time_total}s\n

# 2. Check network latency
ping -c 10 localhost

# 3. Monitor connections
netstat -an | grep :3000 | wc -l</code></pre>
    </div>
    
    <h2 id="logging-debugging">Logging & Debugging</h2>
    
    <h3>Enable Verbose Logging</h3>
    
    <pre><code># Run with verbose flag
rusty-beam -v config.html

# Or set environment variable
RUST_LOG=debug rusty-beam config.html

# For specific modules
RUST_LOG=rusty_beam=debug,hyper=info rusty-beam config.html

# Log to file
rusty-beam -v config.html 2>&1 | tee rusty-beam.log</code></pre>
    
    <h3>Debug Specific Components</h3>
    
    <table>
        <thead>
            <tr>
                <th>Component</th>
                <th>Log Level</th>
                <th>What It Shows</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Plugin loading</td>
                <td>RUST_LOG=rusty_beam::plugin=trace</td>
                <td>Plugin initialization, errors</td>
            </tr>
            <tr>
                <td>Request handling</td>
                <td>RUST_LOG=rusty_beam::handler=debug</td>
                <td>Request flow, responses</td>
            </tr>
            <tr>
                <td>File operations</td>
                <td>RUST_LOG=rusty_beam::file=debug</td>
                <td>File access, permissions</td>
            </tr>
            <tr>
                <td>Authentication</td>
                <td>RUST_LOG=basic_auth=debug</td>
                <td>Auth attempts, failures</td>
            </tr>
        </tbody>
    </table>
    
    <h3>Structured Logging</h3>
    
    <pre><code># Parse JSON logs
rusty-beam config.html 2>&1 | jq 'select(.level=="ERROR")'

# Filter by field
rusty-beam config.html 2>&1 | jq 'select(.module=="rusty_beam::auth")'

# Watch for errors
rusty-beam config.html 2>&1 | jq 'select(.level=="ERROR" or .level=="WARN")'</code></pre>
    
    <h2 id="common-errors">Common Error Messages</h2>
    
    <h3>Quick Reference</h3>
    
    <table>
        <thead>
            <tr>
                <th>Error Message</th>
                <th>Likely Cause</th>
                <th>Quick Fix</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Address already in use</td>
                <td>Port occupied</td>
                <td>Kill process or change port</td>
            </tr>
            <tr>
                <td>Permission denied</td>
                <td>File permissions or port &lt; 1024</td>
                <td>Fix permissions or use high port</td>
            </tr>
            <tr>
                <td>Too many open files</td>
                <td>Ulimit too low</td>
                <td>Increase ulimit: ulimit -n 65535</td>
            </tr>
            <tr>
                <td>Connection reset by peer</td>
                <td>Client timeout or crash</td>
                <td>Check client code, increase timeouts</td>
            </tr>
            <tr>
                <td>Broken pipe</td>
                <td>Client disconnected</td>
                <td>Normal for interrupted transfers</td>
            </tr>
            <tr>
                <td>Plugin not found</td>
                <td>Wrong path or missing file</td>
                <td>Check plugin path and permissions</td>
            </tr>
            <tr>
                <td>Invalid selector</td>
                <td>CSS syntax error</td>
                <td>Validate selector syntax</td>
            </tr>
            <tr>
                <td>No space left on device</td>
                <td>Disk full</td>
                <td>Free disk space</td>
            </tr>
        </tbody>
    </table>
    
    <h2 id="getting-help">Getting Help</h2>
    
    <h3>Before Asking for Help</h3>
    
    <ol>
        <li><strong>Collect information:</strong>
            <pre><code># System info
uname -a
rusty-beam --version

# Configuration (sanitized)
cat config.html | grep -v password

# Error messages
journalctl -u rusty-beam --since "1 hour ago"

# Installed plugins
ls -la /usr/local/lib/rusty-beam/plugins/</code></pre>
        </li>
        
        <li><strong>Try minimal configuration:</strong>
            <pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;body&gt;
    &lt;table itemscope itemtype="http://rustybeam.net/ServerConfig"&gt;
        &lt;tr&gt;&lt;td itemprop="root"&gt;./test&lt;/td&gt;&lt;/tr&gt;
    &lt;/table&gt;
    &lt;ul&gt;
        &lt;li itemscope itemtype="http://rustybeam.net/VirtualHost"&gt;
            &lt;span itemprop="host"&gt;*&lt;/span&gt;
            &lt;ul&gt;
                &lt;li itemprop="plugin" itemscope itemtype="http://rustybeam.net/Plugin"&gt;
                    &lt;span itemprop="library"&gt;file://./plugins/lib/file-handler.so&lt;/span&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
        &lt;/li&gt;
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
        </li>
        
        <li><strong>Search existing issues:</strong>
            <ul>
                <li>GitHub Issues</li>
                <li>Documentation</li>
                <li>Community forums</li>
            </ul>
        </li>
    </ol>
    
    <h3>Reporting Issues</h3>
    
    <p>Include in your bug report:</p>
    <ul>
        <li>Rusty Beam version</li>
        <li>Operating system and version</li>
        <li>Configuration file (sanitized)</li>
        <li>Steps to reproduce</li>
        <li>Expected behavior</li>
        <li>Actual behavior</li>
        <li>Error messages and logs</li>
    </ul>
    
    <div class="info">
        <strong>Pro Tip:</strong> Most issues can be resolved by:
        <ol>
            <li>Checking file permissions</li>
            <li>Verifying configuration syntax</li>
            <li>Ensuring plugins are in correct order</li>
            <li>Running with verbose logging</li>
        </ol>
    </div>
    
    <h2>See Also</h2>
    
    <ul>
        <li><a href="/guides/getting-started.html">Getting Started</a> - Basic setup</li>
        <li><a href="/reference/configuration.html">Configuration Reference</a> - All options</li>
        <li><a href="/guides/security.html">Security Guide</a> - Security issues</li>
        <li><a href="/guides/performance.html">Performance Guide</a> - Performance issues</li>
    </ul>
    
    <footer>
        <p>© 2024 Rusty Beam Project</p>
    </footer>
</body>
</html>