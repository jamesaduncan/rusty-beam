<!DOCTYPE html>
<html>
<head>
    <title>Security Guide - Rusty Beam</title>
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1, h2, h3 { color: #333; }
        code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #f8f8f8; font-weight: bold; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .info { background: #e3f2fd; border: 1px solid #bbdefb; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .danger { background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 5px; margin: 20px 0; }
        nav { margin-bottom: 20px; }
        nav a { margin-right: 10px; }
        .security-level { display: inline-block; padding: 4px 8px; border-radius: 3px; font-weight: bold; color: white; }
        .level-critical { background: #dc3545; }
        .level-high { background: #fd7e14; }
        .level-medium { background: #ffc107; color: #333; }
        .level-low { background: #28a745; }
    </style>
</head>
<body>
    <nav>
        <a href="/">Home</a> → 
        <a href="/guides/">Guides</a> → 
        Security
    </nav>
    
    <h1>Security Guide</h1>
    
    <p>This guide covers security best practices for deploying and maintaining Rusty Beam in production environments.</p>
    
    <div class="warning">
        <strong>Security Notice:</strong> Security is a shared responsibility. While Rusty Beam provides security features, proper configuration and deployment practices are essential for maintaining a secure system.
    </div>
    
    <h2>Table of Contents</h2>
    <ul>
        <li><a href="#overview">Security Overview</a></li>
        <li><a href="#authentication">Authentication & Authorization</a></li>
        <li><a href="#network">Network Security</a></li>
        <li><a href="#file-security">File System Security</a></li>
        <li><a href="#input-validation">Input Validation</a></li>
        <li><a href="#headers">Security Headers</a></li>
        <li><a href="#ssl-tls">SSL/TLS Configuration</a></li>
        <li><a href="#rate-limiting">Rate Limiting & DDoS Protection</a></li>
        <li><a href="#logging">Security Logging & Monitoring</a></li>
        <li><a href="#hardening">System Hardening</a></li>
        <li><a href="#checklist">Security Checklist</a></li>
        <li><a href="#incident-response">Incident Response</a></li>
    </ul>
    
    <h2 id="overview">Security Overview</h2>
    
    <p>Rusty Beam implements multiple layers of security:</p>
    
    <ol>
        <li><strong>Path Traversal Protection</strong>: All file paths are canonicalized</li>
        <li><strong>Plugin Isolation</strong>: Plugins run with limited permissions</li>
        <li><strong>Input Validation</strong>: CSS selectors and file paths are validated</li>
        <li><strong>Authentication Support</strong>: Built-in authentication plugins</li>
        <li><strong>Rate Limiting</strong>: Protection against abuse</li>
    </ol>
    
    <h3>Security Architecture</h3>
    
    <pre>
    Internet → Firewall → Reverse Proxy (SSL) → Rusty Beam
                              ↓                      ↓
                         WAF Rules            Security Plugins
                                                    ↓
                                              File System
                                            (Restricted Access)
    </pre>
    
    <h2 id="authentication">Authentication & Authorization</h2>
    
    <h3>Basic Authentication Setup</h3>
    
    <p>Configure strong authentication for sensitive areas:</p>
    
    <pre><code>&lt;!-- Secure user configuration --&gt;
&lt;table&gt;
    &lt;tr itemscope itemtype="http://rustybeam.net/User"&gt;
        &lt;td itemprop="username"&gt;admin&lt;/td&gt;
        &lt;!-- Use bcrypt for production --&gt;
        &lt;td itemprop="password"&gt;$2b$12$K.3X7Px7CAzN.dt8j5Dz5ufVx3Gk6t0X3H0ec4qYn5JH3gQyKaFJO&lt;/td&gt;
        &lt;td itemprop="role"&gt;administrators&lt;/td&gt;
        &lt;td itemprop="encryption"&gt;bcrypt&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;</code></pre>
    
    <h3>Password Security</h3>
    
    <div class="danger">
        <strong>Critical:</strong> Never use plaintext passwords in production!
    </div>
    
    <p>Generate secure bcrypt hashes:</p>
    
    <pre><code># Python method
python3 -c "import bcrypt; print(bcrypt.hashpw(b'SecurePassword123!', bcrypt.gensalt(rounds=12)).decode())"

# Using htpasswd
htpasswd -bnBC 12 "" "SecurePassword123!" | tr -d ':\n'

# Password requirements
- Minimum 12 characters
- Mix of uppercase, lowercase, numbers, symbols
- No dictionary words
- Unique per user
- Regular rotation (90 days)</code></pre>
    
    <h3>Authorization Policies</h3>
    
    <pre><code>&lt;!-- Restrictive authorization policies --&gt;
&lt;table&gt;
    &lt;!-- Admin full access --&gt;
    &lt;tr itemscope itemtype="http://rustybeam.net/Policy"&gt;
        &lt;td itemprop="name"&gt;admin-access&lt;/td&gt;
        &lt;td itemprop="path"&gt;/*&lt;/td&gt;
        &lt;td itemprop="methods"&gt;GET,POST,PUT,DELETE&lt;/td&gt;
        &lt;td itemprop="roles"&gt;administrators&lt;/td&gt;
    &lt;/tr&gt;
    
    &lt;!-- Read-only for users --&gt;
    &lt;tr itemscope itemtype="http://rustybeam.net/Policy"&gt;
        &lt;td itemprop="name"&gt;user-read&lt;/td&gt;
        &lt;td itemprop="path"&gt;/public/*&lt;/td&gt;
        &lt;td itemprop="methods"&gt;GET&lt;/td&gt;
        &lt;td itemprop="roles"&gt;users&lt;/td&gt;
    &lt;/tr&gt;
    
    &lt;!-- Deny uploads to sensitive paths --&gt;
    &lt;tr itemscope itemtype="http://rustybeam.net/Policy"&gt;
        &lt;td itemprop="name"&gt;deny-config-writes&lt;/td&gt;
        &lt;td itemprop="path"&gt;/config/*&lt;/td&gt;
        &lt;td itemprop="methods"&gt;PUT,POST,DELETE&lt;/td&gt;
        &lt;td itemprop="roles"&gt;*&lt;/td&gt;
        &lt;td itemprop="action"&gt;deny&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;</code></pre>
    
    <h2 id="network">Network Security</h2>
    
    <h3>Firewall Configuration</h3>
    
    <pre><code># UFW (Ubuntu/Debian)
# Allow only necessary ports
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp  # SSH (restrict source IPs)
ufw allow 80/tcp  # HTTP (redirect to HTTPS)
ufw allow 443/tcp # HTTPS
ufw enable

# iptables rules
# Rate limit connections
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -m limit --limit 50/minute --limit-burst 200 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -m state --state NEW -j DROP

# Block common attack patterns
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP  # NULL packets
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP   # XMAS packets
iptables -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP</code></pre>
    
    <h3>Bind to Localhost</h3>
    
    <p>When using a reverse proxy, bind Rusty Beam to localhost only:</p>
    
    <pre><code>&lt;table itemscope itemtype="http://rustybeam.net/ServerConfig"&gt;
    &lt;tr&gt;
        &lt;td&gt;Bind Address&lt;/td&gt;
        &lt;td itemprop="bind"&gt;127.0.0.1&lt;/td&gt;
        &lt;td&gt;Only accessible locally&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;</code></pre>
    
    <h3>Network Segmentation</h3>
    
    <ul>
        <li>Deploy in DMZ or isolated subnet</li>
        <li>Use private VLANs for backend communication</li>
        <li>Implement network ACLs</li>
        <li>Monitor for unusual traffic patterns</li>
    </ul>
    
    <h2 id="file-security">File System Security</h2>
    
    <h3>Directory Permissions</h3>
    
    <pre><code># Set restrictive permissions
# Configuration (read-only)
chmod 640 /etc/rusty-beam/config.html
chown root:rustybeam /etc/rusty-beam/config.html

# User database (sensitive)
chmod 600 /etc/rusty-beam/users.html
chown rustybeam:rustybeam /etc/rusty-beam/users.html

# Content directory
chmod 755 /var/www
chown -R rustybeam:rustybeam /var/www
find /var/www -type f -exec chmod 644 {} \;
find /var/www -type d -exec chmod 755 {} \;

# Log directory
chmod 750 /var/log/rusty-beam
chown rustybeam:adm /var/log/rusty-beam</code></pre>
    
    <h3>Path Traversal Protection</h3>
    
    <p>Rusty Beam automatically prevents path traversal attacks:</p>
    
    <ul>
        <li>All paths are canonicalized</li>
        <li>Symlinks are resolved</li>
        <li>Access outside document root is denied</li>
        <li>Hidden files (starting with .) are protected</li>
    </ul>
    
    <div class="info">
        <strong>Built-in Protection:</strong> The <code>canonicalize_file_path()</code> function ensures all file access is restricted to the configured document root.
    </div>
    
    <h3>Upload Security</h3>
    
    <pre><code># Restrict upload directories
# Create separate upload directory
mkdir -p /var/www/uploads
chmod 1777 /var/www/uploads  # Sticky bit prevents deletion by others

# Configure plugin to restrict file types
&lt;li itemprop="plugin" itemscope itemtype="http://rustybeam.net/Plugin"&gt;
    &lt;span itemprop="library"&gt;file://./plugins/lib/upload-filter.so&lt;/span&gt;
    &lt;meta itemprop="allowed-extensions" content="jpg,png,pdf,txt"&gt;
    &lt;meta itemprop="max-size" content="10485760"&gt; &lt;!-- 10MB --&gt;
    &lt;meta itemprop="scan-uploads" content="true"&gt;
&lt;/li&gt;</code></pre>
    
    <h2 id="input-validation">Input Validation</h2>
    
    <h3>CSS Selector Security</h3>
    
    <p>The selector-handler plugin validates CSS selectors to prevent:</p>
    
    <ul>
        <li>Malformed selectors that could crash the parser</li>
        <li>Excessive complexity that could cause DoS</li>
        <li>Injection attacks through selector manipulation</li>
    </ul>
    
    <h3>Filename Validation</h3>
    
    <p>Implement strict filename validation:</p>
    
    <pre><code># Safe filename pattern
^[a-zA-Z0-9][a-zA-Z0-9._-]*$

# Reject dangerous patterns
- Null bytes (\0)
- Directory traversal (../)
- Absolute paths (/)
- Special characters (<, >, |, &)
- Control characters</code></pre>
    
    <h3>Request Size Limits</h3>
    
    <pre><code># Nginx configuration
client_max_body_size 10M;
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 16k;</code></pre>
    
    <h2 id="headers">Security Headers</h2>
    
    <h3>Configure Security Headers Plugin</h3>
    
    <pre><code>&lt;li itemprop="plugin" itemscope itemtype="http://rustybeam.net/Plugin"&gt;
    &lt;span itemprop="library"&gt;file://./plugins/lib/security-headers.so&lt;/span&gt;
    
    &lt;!-- Strict Transport Security --&gt;
    &lt;meta itemprop="hsts-max-age" content="31536000"&gt;
    &lt;meta itemprop="hsts-include-subdomains" content="true"&gt;
    &lt;meta itemprop="hsts-preload" content="true"&gt;
    
    &lt;!-- Content Security Policy --&gt;
    &lt;meta itemprop="csp" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';"&gt;
    
    &lt;!-- Other security headers --&gt;
    &lt;meta itemprop="x-frame-options" content="DENY"&gt;
    &lt;meta itemprop="x-content-type-options" content="nosniff"&gt;
    &lt;meta itemprop="x-xss-protection" content="1; mode=block"&gt;
    &lt;meta itemprop="referrer-policy" content="strict-origin-when-cross-origin"&gt;
    &lt;meta itemprop="permissions-policy" content="geolocation=(), microphone=(), camera=()"&gt;
&lt;/li&gt;</code></pre>
    
    <h3>Custom Security Headers</h3>
    
    <table>
        <thead>
            <tr>
                <th>Header</th>
                <th>Value</th>
                <th>Purpose</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>X-Permitted-Cross-Domain-Policies</td>
                <td>none</td>
                <td>Prevent Flash/PDF cross-domain</td>
            </tr>
            <tr>
                <td>X-Download-Options</td>
                <td>noopen</td>
                <td>Prevent IE file execution</td>
            </tr>
            <tr>
                <td>X-DNS-Prefetch-Control</td>
                <td>off</td>
                <td>Disable DNS prefetching</td>
            </tr>
        </tbody>
    </table>
    
    <h2 id="ssl-tls">SSL/TLS Configuration</h2>
    
    <h3>Strong SSL Configuration</h3>
    
    <pre><code># Nginx SSL configuration
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers off;
ssl_dhparam /etc/ssl/dhparam.pem;  # Generate: openssl dhparam -out dhparam.pem 4096
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/letsencrypt/live/example.com/chain.pem;</code></pre>
    
    <h3>Certificate Management</h3>
    
    <ul>
        <li>Use Let's Encrypt for free certificates</li>
        <li>Automate renewal with certbot</li>
        <li>Monitor expiration dates</li>
        <li>Use Certificate Transparency</li>
        <li>Implement HPKP carefully (or skip it)</li>
    </ul>
    
    <h2 id="rate-limiting">Rate Limiting & DDoS Protection</h2>
    
    <h3>Rate Limit Configuration</h3>
    
    <pre><code>&lt;li itemprop="plugin" itemscope itemtype="http://rustybeam.net/Plugin"&gt;
    &lt;span itemprop="library"&gt;file://./plugins/lib/rate-limit.so&lt;/span&gt;
    
    &lt;!-- General limits --&gt;
    &lt;meta itemprop="requests-per-minute" content="60"&gt;
    &lt;meta itemprop="burst-size" content="10"&gt;
    
    &lt;!-- Stricter limits for sensitive operations --&gt;
    &lt;meta itemprop="auth-attempts-per-hour" content="5"&gt;
    &lt;meta itemprop="upload-requests-per-hour" content="10"&gt;
    
    &lt;!-- Response when rate limited --&gt;
    &lt;meta itemprop="rate-limit-message" content="Too many requests. Please try again later."&gt;
    &lt;meta itemprop="retry-after" content="60"&gt;
&lt;/li&gt;</code></pre>
    
    <h3>DDoS Mitigation</h3>
    
    <ol>
        <li><strong>Network Level</strong>
            <ul>
                <li>Use DDoS protection service (Cloudflare, AWS Shield)</li>
                <li>Implement SYN cookies</li>
                <li>Rate limit at firewall</li>
            </ul>
        </li>
        <li><strong>Application Level</strong>
            <ul>
                <li>Connection limits per IP</li>
                <li>Request size limits</li>
                <li>Timeout aggressive clients</li>
            </ul>
        </li>
        <li><strong>Resource Protection</strong>
            <ul>
                <li>Cache static content</li>
                <li>Limit expensive operations</li>
                <li>Use circuit breakers</li>
            </ul>
        </li>
    </ol>
    
    <h2 id="logging">Security Logging & Monitoring</h2>
    
    <h3>Security Events to Log</h3>
    
    <ul>
        <li>Authentication failures</li>
        <li>Authorization denials</li>
        <li>Invalid input attempts</li>
        <li>Rate limit violations</li>
        <li>File upload attempts</li>
        <li>Configuration changes</li>
        <li>Error responses (4xx, 5xx)</li>
    </ul>
    
    <h3>Log Analysis</h3>
    
    <pre><code># Monitor authentication failures
grep "401 Unauthorized" /var/log/rusty-beam/access.log | awk '{print $1}' | sort | uniq -c | sort -rn

# Detect scanning attempts
grep -E "(\.\.\/|\.git|\.env|wp-admin)" /var/log/rusty-beam/access.log

# Monitor high error rates
awk '$9 >= 400 {print $1, $9}' /var/log/rusty-beam/access.log | sort | uniq -c | sort -rn

# Set up alerts
tail -f /var/log/rusty-beam/access.log | grep --line-buffered "401\|403" | while read line; do
    echo "Security alert: $line" | mail -s "Rusty Beam Security Alert" admin@example.com
done</code></pre>
    
    <h3>Security Information and Event Management (SIEM)</h3>
    
    <p>Integrate with SIEM systems:</p>
    
    <pre><code># Rsyslog forwarding to SIEM
*.* @@siem-server:514

# Structured logging format
&lt;meta itemprop="log-format" content="json"&gt;

# Include security context
{
  "timestamp": "2024-01-09T10:30:45Z",
  "level": "warning",
  "event": "auth_failure",
  "user": "unknown",
  "ip": "192.168.1.100",
  "path": "/admin",
  "user_agent": "Mozilla/5.0..."
}</code></pre>
    
    <h2 id="hardening">System Hardening</h2>
    
    <h3>Operating System Hardening</h3>
    
    <pre><code># Disable unnecessary services
systemctl disable bluetooth
systemctl disable cups
systemctl disable avahi-daemon

# Kernel hardening (sysctl.conf)
kernel.dmesg_restrict = 1
kernel.kptr_restrict = 2
kernel.yama.ptrace_scope = 1
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv6.conf.all.accept_ra = 0

# Enable AppArmor/SELinux
aa-enforce /etc/apparmor.d/usr.local.bin.rusty-beam</code></pre>
    
    <h3>Container Security</h3>
    
    <pre><code># Dockerfile security
FROM rust:1.70-slim as builder
# ... build steps ...

FROM gcr.io/distroless/cc-debian12
COPY --from=builder /app/rusty-beam /
USER nonroot:nonroot
EXPOSE 3000
ENTRYPOINT ["/rusty-beam"]

# Run with security options
docker run --security-opt=no-new-privileges:true \
           --read-only \
           --tmpfs /tmp:noexec,nosuid,size=64M \
           --cap-drop=ALL \
           --cap-add=NET_BIND_SERVICE \
           rusty-beam:latest</code></pre>
    
    <h3>Security Scanning</h3>
    
    <pre><code># Vulnerability scanning
# Scan dependencies
cargo audit

# Static analysis
cargo clippy -- -D warnings

# Dynamic analysis
# Run OWASP ZAP or similar against test instance

# Container scanning
trivy image rusty-beam:latest

# System scanning
lynis audit system</code></pre>
    
    <h2 id="checklist">Security Checklist</h2>
    
    <h3>Initial Deployment</h3>
    
    <table>
        <thead>
            <tr>
                <th>Task</th>
                <th>Priority</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>☐ Configure firewall rules</td>
                <td><span class="security-level level-critical">Critical</span></td>
                <td>Pending</td>
            </tr>
            <tr>
                <td>☐ Set up SSL/TLS certificates</td>
                <td><span class="security-level level-critical">Critical</span></td>
                <td>Pending</td>
            </tr>
            <tr>
                <td>☐ Enable authentication</td>
                <td><span class="security-level level-critical">Critical</span></td>
                <td>Pending</td>
            </tr>
            <tr>
                <td>☐ Configure security headers</td>
                <td><span class="security-level level-high">High</span></td>
                <td>Pending</td>
            </tr>
            <tr>
                <td>☐ Set up rate limiting</td>
                <td><span class="security-level level-high">High</span></td>
                <td>Pending</td>
            </tr>
            <tr>
                <td>☐ Configure logging</td>
                <td><span class="security-level level-high">High</span></td>
                <td>Pending</td>
            </tr>
            <tr>
                <td>☐ Set file permissions</td>
                <td><span class="security-level level-medium">Medium</span></td>
                <td>Pending</td>
            </tr>
            <tr>
                <td>☐ Enable monitoring</td>
                <td><span class="security-level level-medium">Medium</span></td>
                <td>Pending</td>
            </tr>
        </tbody>
    </table>
    
    <h3>Ongoing Maintenance</h3>
    
    <ul>
        <li>☐ Weekly: Review security logs</li>
        <li>☐ Monthly: Update dependencies</li>
        <li>☐ Monthly: Review user access</li>
        <li>☐ Quarterly: Security audit</li>
        <li>☐ Quarterly: Penetration testing</li>
        <li>☐ Annually: Full security review</li>
    </ul>
    
    <h2 id="incident-response">Incident Response</h2>
    
    <h3>Incident Response Plan</h3>
    
    <ol>
        <li><strong>Detection</strong>
            <ul>
                <li>Monitor alerts and logs</li>
                <li>Investigate anomalies</li>
                <li>Verify incident</li>
            </ul>
        </li>
        <li><strong>Containment</strong>
            <ul>
                <li>Isolate affected systems</li>
                <li>Block malicious IPs</li>
                <li>Disable compromised accounts</li>
            </ul>
        </li>
        <li><strong>Eradication</strong>
            <ul>
                <li>Remove malicious files</li>
                <li>Patch vulnerabilities</li>
                <li>Reset credentials</li>
            </ul>
        </li>
        <li><strong>Recovery</strong>
            <ul>
                <li>Restore from backups</li>
                <li>Monitor for reinfection</li>
                <li>Gradually restore access</li>
            </ul>
        </li>
        <li><strong>Lessons Learned</strong>
            <ul>
                <li>Document incident</li>
                <li>Update procedures</li>
                <li>Implement improvements</li>
            </ul>
        </li>
    </ol>
    
    <h3>Emergency Contacts</h3>
    
    <pre><code># Create incident response contacts file
cat > /etc/rusty-beam/emergency-contacts.txt << EOF
Security Team Lead: +1-555-0123
System Administrator: +1-555-0124
Management: +1-555-0125
External Security: security@example.com
EOF

chmod 600 /etc/rusty-beam/emergency-contacts.txt</code></pre>
    
    <div class="warning">
        <strong>Remember:</strong> Security is an ongoing process, not a one-time configuration. Regular reviews, updates, and vigilance are essential for maintaining a secure system.
    </div>
    
    <h2>See Also</h2>
    
    <ul>
        <li><a href="/plugins/basic-auth/">Basic Auth Plugin</a> - Authentication setup</li>
        <li><a href="/plugins/authorization/">Authorization Plugin</a> - Access control</li>
        <li><a href="/plugins/security-headers/">Security Headers Plugin</a> - Header configuration</li>
        <li><a href="/guides/deployment.html">Deployment Guide</a> - Secure deployment</li>
        <li><a href="https://owasp.org/">OWASP</a> - Web application security</li>
    </ul>
    
    <footer>
        <p>© 2024 Rusty Beam Project</p>
    </footer>
</body>
</html>